{% extends "layout.jinja2" %}

{% block title %}{{ node.name }}{% endblock %}

{% macro version_class(delta) -%}
  {%- if delta == 0 -%}
    <span class="icon has-text-success"><i class="fas fa-check-square"></i></span>
  {%- elif delta == 1 -%}
    <span class="icon has-text-info"><i class="fas fa-info-circle"></i></span>
  {%- elif delta == 3 -%}
    <span class="icon has-text-danger"><i class="fas fa-exclamation-triangle"></i></span>
  {%- else -%}
    <span class="icon has-text-warning"><i class="fas fa-exclamation-triangle"></i></span>
  {%- endif %}
{%- endmacro %}

{% block content %}
<div class="container">
  <h1 class="title">{{ node.name }}</h1>
  <div class="content">
    {{ node.description}}
  </div>
  <div class="columns">
    <div class="column">
      <div class="mb-2">
        <div class="heading">Location</div>
        <div>
          {% if node.latitude or node.longitude %}
            {{ node.latitude }}, {{ node.longitude }}
          {% else %}
            Unknown
          {% endif %}
          </div>
      </div>
      <div class="mb-2">
        <div class="heading">Grid Square</div>
        <div>{{ node.grid_square }}</div>
      </div>
      <div class="mb-2">
        <div class="heading">Last Seen</div>
        <div>{{ node.last_seen|local_tz }}</div>
      </div>
      <div class="mb-2">
        <a href="http://{{ node.wlan_ip }}:8080">AREDN Details</a>
      </div>
    </div>
    <div class="column">
      <div class="mb-2">
        <div class="heading">Status</div>
        <div>{{ node.status }}</div>
      </div>
      <div class="mb-2">
        <div class="heading">IP Address</div>
        <div>{{ node.wlan_ip }}</div>
      </div>
      <div class="mb-2">
        <div class="heading">Up Time</div>
        <div>{{ node.up_time }}</div>
      </div>
      <div class="mb-2">
        <div class="heading">Load Averages</div>
        <div>{{ node.load_averages }}</div>
      </div>
    </div>
    <div class="column">
      <div class="mb-2">
        <div class="heading">Model</div>
        <div>{{ node.model }}</div>
      </div>
      <div class="mb-2">
        <div class="heading">Board ID</div>
        <div>{{ node.board_id }}</div>
      </div>
      <div class="mb-2">
        <div class="heading">Firmware Manufacturer</div>
        <div>{{ node.firmware_manufacturer }}</div>
      </div>
      <div class="mb-2">
        <div class="heading">Firmware Version</div>
        <div>{{ node.firmware_version }} {{ version_class(firmware_status) }}</div>
      </div>
      <div class="mb-2">
        <div class="heading">API Version</div>
        <div>{{ node.api_version }} {{ version_class(api_status) }}</div>
      </div>
    </div>
    <div class="column">
      <div class="mb-2">
        <div class="heading">SSID</div>
        <div>{{ node.ssid }}</div>
      </div>
      <div class="mb-2">
        <div class="heading">Channel</div>
        <div>{{ node.channel }}</div>
      </div>
      <div class="mb-2">
        <div class="heading">Band</div>
        <div>{{ node.band }}</div>
      </div>
      <div class="mb-2">
        <div class="heading">Channel Bandwidth</div>
        <div>{{ node.channel_bandwidth }}</div>
      </div>
    </div>
  </div>

{% for graph in ("links", "load", "uptime") %}
  <div class="columns">
  {% for period in ("day", "month") %}
    <div class="column is-narrow">
    <img src="{{ req.route_path('node-graph', id=node.id, name=graph, _query={"period": period}) }}"
         alt="node {{ graph }} graph ({{ period }})"
         width="497"
         loading="lazy"
    >
    </div>
  {% endfor %}
  </div>
{% endfor %}

<h2 class="title is-spaced">Links</h2>

  {# Links is  #}
  {% for link_name, link_types in links|groupby("destination.name") %}
    <h3 class="subtitle">
      <a href="{{ req.route_url("node", id=link_types[0].destination_id) }}">{{ link_name }}</a>
    </h3>
    <div class="columns">
      <div class="column is-narrow-desktop">
        <div class="mb-2">
          <div class="heading">Distance</div>
          <div>{{ link_types[0].distance }}km</div>
        </div>
      </div>
      <div class="column is-narrow-desktop">
        <div class="mb-2">
          <div class="heading">Bearing</div>
          <div>{{ link_types[0].bearing }}</div>
        </div>
      </div>
    </div>
    {% for link in link_types %}
      <h4 class="is-5 block">Type: {{ link.type_name|upper }}</h4>
      <div class="columns">
        <div class="column is-narrow">
          <div class="mb-2">
            <div class="heading">Status</div>
            <div>{{ link.status }}</div>
          </div>
          <div class="mb-2">
            <div class="heading">Last Seen</div>
            <div>{{ link.last_seen|local_tz }}</div>
          </div>
          <div class="mb-2">
            <div class="heading">Route Cost</div>
            <div>{{ link.olsr_cost }}</div>
          </div>
        </div>
        {% if link.type_name|lower == "radio" %}
          <div class="column is-narrow">
            <div class="mb-2">
              <div class="heading">Signal/Noise Ratio</div>
              <div>{{ link.signal_noise_ratio }}</div>
            </div>
            <div class="mb-2">
              <div class="heading">Link Quality</div>
              <div>{{ link.quality }}</div>
            </div>
            <div class="mb-2">
              <div class="heading">Neighbor Link Quality</div>
              <div>{{ link.neighbor_quality }}</div>
            </div>
          </div>
        {% endif %}
      </div>
      <div class="columns">
        {% for period in ("day", "month") %}
          <div class="column is-narrow">
            <img src="{{ req.route_path('link-graph', source=link.source_id, destination=link.destination_id, name="cost", _query={"period": period}) }}"
                 alt="link cost graph ({{ period }})"
                 loading="lazy">
          </div>
        {% endfor %}
      </div>
      {% if link.type_name|lower == "radio" %}
        {% for graph in ("snr", "quality") %}
          <div class="columns">
            {% for period in ("day", "month") %}
              <div class="column is-narrow">
                <img src="{{ req.route_path('link-graph', source=link.source_id, destination=link.destination_id, name=graph, _query={"period": period}) }}"
                     alt="link {{ graph }} graph ({{ period }})"
                     loading="lazy">
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      {% endif %}

    {% endfor %}

  {% endfor %}
</div>

{% endblock %}
